<script>
  function showUser(data) {
    document.getElementById("user").innerHTML = data;
  }

  function generateInstituteSelect(data) { // створюємо випадний список для вибору інституту
    const institutes = Object.values(data).map(el => {
      return {
        key: el.idinstitute,
        value: el.nameinstitute
      }
    });
    institutes.unshift({
      key: 0,
      value: "Інститут /Факультет"
    });
    document.getElementById("institute").innerHTML = generateSelect(institutes, "select-institute");
  }

  function generateEducationalDegreeSelect(data) { // створюємо випадний список для вибору освітнього ступеня
    const educationalDegree = Object.values(data).map(el => {
      return {
        key: el.educationaldegreeid,
        value: el.educationaldegreename
      }
    });
    educationalDegree.unshift({
      key: 0,
      value: "Освітній рівень"
    });
    document.getElementById("educationalDegree").innerHTML = generateSelect(educationalDegree,
      "select-educationalDegree");
  }

  function generateFormTrainingSelect(data) { // створюємо випадний список для вибору форми навчання
    const formTraining = Object.values(data).map(el => {
      return {
        key: el.formtrainingid,
        value: el.formtrainingname
      }
    });
    formTraining.unshift({
      key: 0,
      value: "Форма навчання"
    });
    document.getElementById("formTraining").innerHTML = generateSelect(formTraining, "select-formTraining");
  }

  function generateCoursSelect(data) { // створюємо випадний список для вибору курсу навчання
    const formTraining = Object.values(data).map(el => {
      return {
        key: el.courseid,
        value: el.coursename
      }
    });
    formTraining.unshift({
      key: 0,
      value: "Курс"
    });
    document.getElementById("cours").innerHTML = generateSelect(formTraining, "select-cours");
  }


  function generateGroupsSelect(data) { // створюємо випадний список для вибору групи
    const groups = Object.values(data).map(el => {
      let buffer = [el.name, el.speciality, el.specialization_label];
      return {
        key: el.groupId,
        value: buffer.filter(el => {
          return el != ""
        }).join(" &rarr; ")
      }
    });
    groups.unshift({
      key: 0,
      value: "Група"
    });
    document.getElementById("groups").innerHTML = generateSelect(groups, "select-groups");
  }

  function generateControlFormSelect(data) {
    const controlForm = Object.values(data).map(el => {
      return {
        key: el.id,
        value: el.value
      }
    });
    controlForm.unshift({
      key: 0,
      value: "Форма підсумкового контролю"
    });
    return generateSelect(controlForm, "controlForm");
  }

  const mainPageMenu = `<ul id="slides">
            <li class="slideActive">
              <div id="teacherEvolutionsLists"></div>
            </li>
            <li>
              <div id="teamEvolutionsLists"></div>
            </li>
          </ul>
          <ul id="pagerMenu">
            <li id="first" class="menuActive">Мої відомості</li>
            <li id="second">Спільні відомості</li>
          </ul>`,
          generatemainPageMenu = function(){
            document.getElementById("evList").innerHTML = mainPageMenu;
          };

  function generateTeacherEvolutionsLists(teachersEvLists, type) {
    let evLists = "";
    if (teachersEvLists.length === 0) {
      document.getElementById(type).innerHTML = "";
    } else {
      teachersEvLists.forEach(el => {
        if (typeof el.parent === "undefined") el.parent = 0;
        let borderColorId = `edit-${el.evaluationListType}-${el.status}`;
        switch (borderColorId) {
          case `edit-1-0`:
            evLists +=
              `<div class="wrappEvList border-gray">
              <button id="edit-${type}-${el.recordNumber}-main">${el.evaluationListData.groupName}, ${el.evaluationListData.academicDiscipline}</button>
              <i id="delete-${type}-${el.recordNumber}" class="fa fa-times"></i>
            </div>`;
            break;
          case `edit-2-0`:
            evLists +=
              `<div class="wrappEvList border-yellow">
              <button id="edit-${type}-${el.recordNumber}-additional">${el.evaluationListData.groupName}, ${el.evaluationListData.academicDiscipline}</button>
              <i id="delete-${type}-${el.recordNumber}" class="fa fa-times"></i>
            </div>`;
            break;
          case `edit-1-1`:
            evLists +=
              `<div class="wrappEvList border-gray background-blue">
                <button>${el.evaluationListData.groupName}, ${el.evaluationListData.academicDiscipline}</button>
                <i id="openSubMenu-${el.recordNumber}" class="fa fa-sort-desc"></i>
                <div id="evList-subMenu-${el.recordNumber}" class="evList-subMenu">
                  <ul>
                    <li><a href="${el.pdfUrl}" target="_blank"><i class="fa fa-file-pdf-o"></i>Переглянути</a></li>
                    <li><button id="createSecondForm-${type}-${el.recordNumber}-${el.parent}"><i class="fa fa-plus"></i>Повторна відомість</button></li>
                    <li><button id="cancelSignature-${type}-${el.recordNumber}"><i class="fa fa-reply-all"></i>Відкликати підпис</button></li>
                  </ul>
                </div>
              </div>`;
            break;
          case `edit-2-1`:
            evLists +=
              `<div class="wrappEvList border-yellow background-blue">
                <button>${el.evaluationListData.groupName}, ${el.evaluationListData.academicDiscipline}</button>
                <i id="openSubMenu-${el.recordNumber}" class="fa fa-sort-desc"></i>
                <div id="evList-subMenu-${el.recordNumber}" class="evList-subMenu">
                  <ul>
                    <li><a href="${el.pdfUrl}" target="_blank"><i class="fa fa-file-pdf-o"></i>Переглянути</a></li>
                    <li><button id="createSecondForm-${type}-${el.recordNumber}-${el.parent}"><i class="fa fa-plus"></i>Повторна відомість</button></li>
                    <li><button id="cancelSignature-${type}-${el.recordNumber}"><i class="fa fa-reply-all"></i>Відкликати підпис</button></li>
                  </ul>
                </div>
              </div>`;
            break;
        }
      });
      document.getElementById(type).innerHTML = evLists;
    }
  }

  function openSubMenu(id) {
    showOrNotShow = true;
    id.splice(0, 1, "evList-subMenu");
    document.getElementById(id.join("-")).style.display = "block";
  }

  function closeSubMenu() {
    showOrNotShow = false;
    let x = document.getElementsByClassName("evList-subMenu");
    if (x.length !== 0) {
      for (let i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
    }
  }

  function generateButtonNewEvList(view) {
    let button;
    if (view) {
      button =
        `<button id='actionsButtons-createFirstForm' style='opacity: 1; cursor: pointer;' class="fa fa-plus"></button>`
    } else {
      button =
        `<button id='actionsButtons-createFirstForm' style='opacity: 0.25; cursor: not-allowed;' class="fa fa-plus" disabled></button>`
    }
    document.getElementById("buttonsActionUnderForm").innerHTML = button;
  }

  function generateForm() {
    const evList = cloneObj(recordData),
      data = evList.evaluationListData;
    let formButtons,
      form,
      tableHeader = ["№", "Прізвище, ініціали студента", "Поточний контроль", "Підсумковий семестровий контроль",
        "Загальна оцінка"
      ],
      tableRow,
      tableMain = [],
      num = 1;

    formButtons = `
       <button id='closeForm'></button>
       <div class="wrap-form-actions-button">
        <button id='actionsButtons-saveForm' class="form-actions-button"><i class="fa fa-floppy-o"></i>Зберегти</button>
        <button id='subscribe-${evList.evaluationListType}' class="form-actions-button"><i class="fa fa-pencil-square-o"></i>Підписати</button>
        <button id='actionsButtons-addMembers' class="form-actions-button"><i class="fa fa-user-plus"></i>Спільний доступ</button>
       </div>`;

    form =
      `<div class="form__group">
        <input type="input" name="formInput" class="form__field" id="academicDiscipline" placeholder="Навчальна дисципліна" value="${data.academicDiscipline}">
        <label for="academicDiscipline" class="form__label">Навчальна дисципліна</label>
      </div>
      <div class="inputWrapp-number-selector-date">
        <div class="form__number">
          <label for="studyCredits">Кількість кредитів</label>
          <input type="number" name="formInput" id="studyCredits" name="number" min="1" max="36" step="1" value="${data.studyCredits}">
        </div>`;

    form += `<div class="form__select">${generateControlFormSelect(handBook.controlForm)}</div>`

    let date = new Date(Number(data.date)).toISOString().slice(0, 10);
    form +=
      `<div class="form__date">
        <label for="date">Дата контролю</label>
        <input type="date" name="formInput" id="date" value="${date}">
      </div>
      </div>
      <div class="form__group">
        <input type="input" name="formInput" class="form__field" id="teacherFullName" placeholder="Посади і ПІБ викладачів, які виставляють підсумкову оцінку" value="${data.teacherFullName}">
        <label for="teacherFullName" class="form__label">Посади і ПІБ викладачів, які виставляють підсумкову оцінку</label>
      </div>
      <div class="form__group">
        <input type="input" name="formInput" class="form__field" id="aditionalTeachers" placeholder="Посади і ПІБ викладачів, які проводили практичні (семінарські, лабораторні) заняття й здійснювали поточний контроль" value="${data.aditionalTeachers.join(", ")}">
        <label for="aditionalTeachers" class="form__label">Посади і ПІБ викладачів, які проводили практичні (семінарські, лабораторні) заняття й здійснювали поточний контроль</label>
      </div>`;

    let arrFildTabie = ["name", "currentGrade", "semesterGrade", "gradeSum"];

    data.students.forEach(el => {
      tableRow = [num];
      arrFildTabie.forEach(key => {
        switch (key) {
          case "name":
            tableRow.push(el[key]);
            break;
          case "gradeSum":
            tableRow.push(
              `<input type="text" name="tableInput" id="${key + "-" + num}" value="${el[key]}" disabled>`);
            break;
          case "semesterGrade":
            tableRow.push(`<input type="text" name="tableInput" id="${key + "-" + num}" value="${el[key]}">
              <i id="lose-${key + "-" + num}" class="fa fa-tag"></i>`);
            break;
          default:
            tableRow.push(`<input type="text" name="tableInput" id="${key + "-" + num}" value="${el[key]}">`);
        }
      });
      ++num;
      tableMain.push(tableRow);
    });
    tableMain.unshift(tableHeader);
    form += createTable(tableMain, "formTable");

    document.getElementById("formButtons").innerHTML = formButtons;
    document.getElementById("form").innerHTML = form;
    document.getElementById("controlForm").value = +data.controlFormId;
  }
  /*----------------- dialogBox("quest", "okButtonId") ----------------------------------------*/

  function dialogBox(quest, okButtonId) {
    const dialogBox =
      `<div class="modalBlock">
        <div class="dialogBox">
          <div class="question">
            <label>${quest}</label>
          </div>
          <div class="yesNoButtons">
            <div id = '${okButtonId}-ok' class="buttonOk">Так</div>
            <div id = 'cancel' class="buttonCancel">Ні</div>
          </>
        </div>
      </div>`;
    document.getElementById('customAlert').innerHTML = dialogBox;
    return false;
  }

  function delDialogBox() {
    document.getElementById('customAlert').innerHTML = "";
    return false;
  }

  /*----------------- add members box with autocomplite ----------------------------------------*/

  function generateAddMembersBox() {
    const membersBox =
      `<div class="modalBlock">
        <div class="abbMembersBox">
          <div class="wrap-close-abbMembersBox"><button id="close-abbMembersBox">Закрити </button></div>
          <label>Додати користувача для спільного редагування</label>
          <div class="wrap-chosen-teacher">
            <ul id="chosen__teacher"></ul>
          </div>
          <div class="chooseTeacher">
            <input type="text" name="autofocus sample" placeholder="Прізвище, ім'я та по батькові" id="autocomplete__input"></input>
            <ul id="autocomplete__results"></ul>
          </div>
          <div class="wrap-finishChoosingTeam">
            <button id="finishChoosingTeam">Готово</button>
          </div>
        </div>
      </div>`
    document.getElementById('modalBox').innerHTML = membersBox;
    document.getElementById('autocomplete__input').focus();

    if (recordData.authorsTeam.length > 0) {
      let chosenTeacher = document.getElementById('chosen__teacher');
      recordData.authorsTeam.forEach(el => {
        let buffer = teachers.filter(elm => {
          return (elm.email === el && el !== handBook.user.email) ? true : false;
        });

        if (buffer.length > 0) {
          const item = document.createElement("li"),
            delIttemButton = document.createElement("i");
          item.className = "chosen-teacher-list-item";
          item.setAttribute("data-id", buffer[0].email);
          item.textContent = buffer[0].name;

          delIttemButton.className = "fa fa-times";
          delIttemButton.setAttribute("data-del", "del-teacher-item");

          item.append(delIttemButton);
          chosenTeacher.append(item);
        }
      });
    }
  }

  function autocomplete(val) {
    var countries_returned = [];

    for (i = 0; i < teachers.length; i++) {
      if (val === teachers[i].name.toLowerCase().slice(0, val.length)) {
        countries_returned.push(teachers[i]);
      }
    }
    return countries_returned;
  }

  function scaningAvtocomplite(val) {
    let autocomplete_results = document.getElementById("autocomplete__results"),
      countries_to_show = [];
    if (val.length > 0) {
      autocomplete_results.innerHTML = "";
      countries_to_show = autocomplete(val);

      for (i = 0; i < countries_to_show.length; i++) {
        autocomplete_results.innerHTML +=
          `<li class="teacher-list-item" data-id="${countries_to_show[i].email}">${countries_to_show[i].name}</li>`;
      }
      autocomplete_results.style.display = "block";
    } else {
      countries_to_show = [];
      autocomplete_results.innerHTML = "";
    }
  }
  /*---------- messageBox("text", "[warning, error, success]")----------------------*/

  let numMessage = 0;
  async function messageBox(messageText, typeOfMessage) {
    numMessage++;
    let message,
      root = document.querySelector(':root');
    switch (typeOfMessage) {
      case "warning":
        root.style.setProperty('--message-color', '#F2C94C'); //warning
        break;
      case "error":
        root.style.setProperty('--message-color', '#EB5757'); //error
        break;
      case "success":
        root.style.setProperty('--message-color', '#27AE60'); //success
        break;
    }
    message =
      `<div id="messageNum-${numMessage}" class="message slideUp">
        <div class="close-message-button"><div class="wrapCMB"><i id="closeMessage-messageNum-${numMessage}" class="fa fa-times"></i></div></div>
        <div class="message-text"><label>${messageText}</label></div>
      </div>`;
    document.getElementById("message").innerHTML += message;
    await delMessageBox(numMessage);
  }

  function delMessageBox(idMesNun) {
    let idMes = `messageNum-${idMesNun}`;
    return new Promise(() => {
      setTimeout(() => {
        let x = document.getElementById(idMes);
        if (x != null) {
          x.remove();
        }
      }, 10000);
    });

  }

  /*----------------------------- createSpiner() ---------------------------------------*/

  function createSpinner() {
    var div = document.createElement("div");
    var faspin = document.createElement("span");
    faspin.className = "fa fa-spinner fa-pulse";
    div.append(faspin);
    div.className = "modalBlock";
    div.id = "modalBlock";
    document.getElementById("data").appendChild(div);
  }

  function deleteSpinner() {
    if (document.getElementById("modalBlock")) document.getElementById("modalBlock").remove();
  }

  /*----------------------------- slider ---------------------------------------*/
  let slide = 0,

    currentSlide = function () {
      let slides = document.querySelectorAll('#slides > li'),
        menu = document.querySelectorAll('#pagerMenu > li'),
        numSlides = slides.length,
        itemToShow = Math.abs(slide % numSlides);
      [].forEach.call(slides, function (el) {
        el.classList.remove('slideActive')
      });
      [].forEach.call(menu, function (el) {
        el.classList.remove('menuActive')
      });
      slides[itemToShow].classList.add('slideActive');
      menu[itemToShow].classList.add('menuActive');
    };
  /*----------------------------- secretary ---------------------------------------*/

  function generateEvaluationListTable(studentsList, data, place, type) {
    studentsList = letterSort('uk', studentsList);
    let table = document.getElementById(place);
    table.innerHTML = '';
    if (!data || !data.length) {
      table.innerHTML = '<h1>' + type + '</h1>' + '<h2>' + 'Відсутні' + '</h2>';
      return;
    }
    let filteredData = data
      .filter((elem) => elem.status === 1)
      .map((elem) => {
        elem.evaluationListData.url = elem.pdfUrl;
        elem.evaluationListData.recordNum = elem.recordNumber;
        return elem.evaluationListData
      });
    let tableArray = [
      [{parameters: 'colspan="3"', contents: ''}],
      ['№', 'ПІБ', 'Залікова книжка'],
      [{parameters: 'colspan="3"', contents:'Реєстраційний №'}]
    ];
    let exams = filteredData.filter((elem) => +elem.controlFormId === 1);
    if (exams.length) {
      if (exams.length === 1)
         tableArray[0].push('Екзамени');
      else 
      tableArray[0].push({parameters: 'colspan="'+ exams.length +'"', contents:'Екзамени'});
    }
    let tests = filteredData.filter((elem) => +elem.controlFormId === 2)
    if (tests.length) {
      if (tests.length === 1)
         tableArray[0].push('Заліки');
      else 
      tableArray[0].push({parameters: 'colspan="'+ tests.length +'"', contents:'Заліки'});
    }
    let creditСoursework = filteredData.filter((elem) => +elem.controlFormId === 3)
    if (creditСoursework.length) {
       if (creditСoursework.length === 1)
         tableArray[0].push('Заліки (курсова робота / практика)');
       else 
         tableArray[0].push({parameters: 'colspan="'+ creditСoursework.length +'"', contents:'Заліки (курсова робота / практика)'});
    }
    filteredData = [...exams, ...tests, ...creditСoursework];
    if (!filteredData || !filteredData.length) {
      table.innerHTML = '<h1>' + type + '</h1>' + '<h2>' + 'Відсутні' + '</h2>';
      return;
    }
    filteredData.forEach((elem, ind) => {
      tableArray[1].push(elem.academicDiscipline + '<a href="' + elem.url +
      '" target="_blank"><i class="fa fa-file-pdf-o"></i></a>');
      tableArray[2].push('<input type="text" id="listNumber-' + elem.recordNum + 
      '" placeholder="№" value="' + elem.listNumber + '" disabled>' 
      + '<div class="icoWrap"><i id="editListNumber-' + elem.recordNum + '" class="fa fa-pencil"></i></div>');
      }); //Заповнюємо таблиці
    
   
    let studentObj = {}
    studentsList.forEach((student, ind) => {
      studentObj[student.sudentId] = [ind + 1, student.name, student.gradebookNumber]
    })

    filteredData.forEach((elem, index) => {
       Object.keys(studentObj).forEach(currentStudentId => {
       let students = elem.students;
       let found = students.filter(function (el) {
           return el.sudentId === currentStudentId;
       });
       if (found.length) studentObj[currentStudentId].push(found[0].gradeSum); else studentObj[currentStudentId].push("") ;
      })
    })
    

    let studentsData = Object.values(studentObj).sort((a, b) => a[0] - b[0]);
/*    let average = studentsData.map((elem, index) => {
      let grade = elem.slice(3).reduce((acc, reducer) => acc + reducer) / (elem.length - 3);
      let studentsAve = [elem[1], grade]
      return studentsAve
    })
*/

    tableArray = [...tableArray, ...studentsData]
    //let tableHtml = createTable(tableArray, 'summaryEvList')
    let tableHtml = createTableBasedOnDataFromObjects(tableArray, 'summaryEvList');
    table.innerHTML = tableHtml;
    // table.innerHTML = '<h1>' + type + '</h1>' + tableHtml;
    return tableHtml
  }

  function genereateTables(data, studentsList) {
    let main = data.filter((list) => list.parent === 0)
    let additional = data.filter((list) => list.parent !== 0)
    generateEvaluationListTable(studentsList, main, 'mainEvList', 'Основні відомості');
    generateEvaluationListTable(studentsList, additional, 'additionalEvList', 'Повторні відомості');
  }
  
</script>