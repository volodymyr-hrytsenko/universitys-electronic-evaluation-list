<script>
  let handBook = {},
    saveOrNotSave = 1, // вказівник на те що відбулися зміни
    showOrNotShow = false; // вказівник на необхідність викликання функції закриття підменю відомостей

  const conformity = {
    educationalDegree: {
      1: "6",
      2: "8"
    },
    controlForm: {
      1: "Екзамен",
      2: "Залік"
    }
  };

  window.onload = function () {
    getDataLists()
      .then((data) => {
        handBook = {};
        handBook = data;
        console.log(data);
        showUser(handBook.user.email);
        generateInstituteSelect(handBook.institutes);
        generateEducationalDegreeSelect(handBook.educational_degree);
        generateFormTrainingSelect(handBook.form_of_training);
        generateCoursSelect(handBook.course_number);
        generateGroupsSelect([]);
        generateButtonNewEvList(false);
      })
      .catch((e) => {})
    setEventScaner();
  }

  function getDataLists() {
    // createSpinner();
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          //deleteSpinner();
          resolve(res);
        })
        .withFailureHandler(reject)
        .getDataFromHandbook(); // це функцыя з gs
    });
  }

  function cloneObj(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function setEventScaner() {
    const page = document.getElementById("data");
    page.addEventListener('change', function (el) {
      if (el.target && el.target.type == "select-one") { //details
        scanningSelectorsEvents(el.target.id);
      } else if (el.target && el.target.name == "formInput") {
        scanningFormInputs(el.target.id);
      } else if (el.target && el.target.name == "tableInput") {
        scanningFormTable(el.target.id);
      }
    });

    page.addEventListener('click', function (el) {
      if (showOrNotShow) closeSubMenu();
      let adres = el.target.id.split("-");
      if (el.target && el.target.name == "actionsButtons") { //details
        scanningActionsButtons(el.target.id);
      } else if (el.target && adres[0] == "edit") {
        runTeachersEvListsForEditing(adres);
      } else if (el.target && adres[0] == "delete") {
        deleteTeacherEvList(adres);
      } else if (el.target && adres[0] == "openSubMenu") {
        openSubMenu(adres);
      } else if (el.target && adres[0] == "closeMessage") {
        adres.shift();
        document.getElementById(adres.join("-")).remove();
      }
    });
  }

  function scanningSelectorsEvents(id) {
    switch (id) {
      case "select-institute":
        recordData.instituteId = +document.getElementById("select-institute").value;

        document.getElementById("select-educationalDegree").value =
          0; // обнуляємо селектори, якщо вони були вибрані раніше
        document.getElementById("select-formTraining").value = 0;
        document.getElementById("select-cours").value = 0;
        document.getElementById("select-groups").value = 0;
        generateButtonNewEvList(false);

        handBook
          .filteredGroupsByEducationalDegree = []; // затираємо дані відфільтровані нижчими повідношенню до даного селекторами
        handBook.filteredGroupsByFormTraining = [];
        handBook.filteredGroupsByCours = [];
        generateGroupsSelect([]);
        handBook.filteredEvListsByEducationalDegree = [];
        handBook.filteredEvListsByFormTraining = [];
        handBook.filteredEvListsByGroup = [];

        createSpinner(); // заблокувати всі селекти поки не виконалось
        getDataInstituteGroups(handBook.institutes[recordData.instituteId]
            .iddivision) // отримуємо всі групи вибраного інституту
          .then((data) => {
            // успіх
            handBook.groups = data;

            getTeacherEvolutionsLists(recordData
                .instituteId) // отримуємо відомості викладача по інституту, якщо такі були створені раніше
              .then((data) => {
                // успіх
                handBook.teacherEvolutionsLists = filterTeachersDelatedEvLists(data);
                generateTeacherEvolutionsLists(handBook.teacherEvolutionsLists);
                deleteSpinner();
              })
              .catch((e) => {
                // помилка
                console.log(e);
              });

          })
          .catch((e) => {
            // помилка
            console.log(e);
          });
        break;
      case "select-educationalDegree":
        recordData.educationalDegreeId = +document.getElementById("select-educationalDegree").value;

        document.getElementById("select-formTraining").value = 0; // обнуляємо селектори, якщо вони були вибрані раніше
        document.getElementById("select-cours").value = 0;
        document.getElementById("select-groups").value = 0;
        generateButtonNewEvList(false);

        handBook
          .filteredGroupsByFormTraining = []; // затираємо дані відфільтровані нижчими повідношенню до даного селекторами
        handBook.filteredGroupsByCours = [];
        handBook.filteredEvListsByFormTraining = [];
        handBook.filteredEvListsByGroup = [];

        //відфільтровуємо дані відповідно до вибраного параметра
        handBook.filteredGroupsByEducationalDegree = filterResources(handBook.groups, "educationalDegreeId", conformity
          .educationalDegree[recordData.educationalDegreeId]);
        handBook.filteredEvListsByEducationalDegree = filterResources(handBook.teacherEvolutionsLists,
          "educationalDegreeId", recordData.educationalDegreeId);

        generateGroupsSelect([]); // виводимо групи, що вдповідають вибраному параметру
        generateTeacherEvolutionsLists(handBook.filteredEvListsByEducationalDegree); // виводимо відомості ...
        break;
      case "select-formTraining":
        recordData.formTrainingId = +document.getElementById("select-formTraining").value;

        document.getElementById("select-cours").value = 0; // обнуляємо селектори, якщо вони були вибрані раніше
        document.getElementById("select-groups").value = 0;
        generateButtonNewEvList(false);

        handBook.filteredGroupsByCours = []; // затираємо дані відфільтровані нижчими повідношенню до даного селекторами
        handBook.filteredEvListsByGroup = [];

        handBook.filteredGroupsByFormTraining = filterResources(handBook.filteredGroupsByEducationalDegree,
          "educationalFormId", (recordData.formTrainingId).toString());
        handBook.filteredEvListsByFormTraining = filterResources(handBook.filteredEvListsByEducationalDegree,
          "formTrainingId", recordData.formTrainingId)

        generateGroupsSelect([]);
        generateTeacherEvolutionsLists(handBook.filteredEvListsByFormTraining);
        break;
      case "select-cours":
        recordData.courseId = +document.getElementById("select-cours").value;

        document.getElementById("select-groups").value = 0; // обнуляємо селектори, якщо вони були вибрані раніше
        generateButtonNewEvList(false);

        handBook.filteredGroupsByCours = filterResources(handBook.filteredGroupsByFormTraining, "course", (recordData
          .courseId).toString());
        generateGroupsSelect(handBook.filteredGroupsByCours);
        break;
      case "select-groups":
        recordData.groupId = +document.getElementById("select-groups").value;

        handBook.filteredEvListsByGroup = filterResources(handBook.filteredEvListsByFormTraining, "groupId", recordData
          .groupId)
        generateTeacherEvolutionsLists(handBook.filteredEvListsByGroup);

        generateButtonNewEvList(true);

        break;
      case "controlForm":
        saveOrNotSave = 0;
        recordData.evaluationListData.controlFormId = document.getElementById("controlForm").value;
        console.log(recordData.evaluationListData.controlFormId);
        recordData.evaluationListData.controlForm = conformity.controlForm[recordData.evaluationListData.controlFormId];
        break;
    }
  }

  function scanningActionsButtons(id) {
    switch (id) {
      case "createFirstForm":
        let groupForEvList = filterResources(handBook.filteredGroupsByCours, "groupId", (recordData.groupId)
          .toString());
        createEvaluationListData(cloneObj(groupForEvList[0]));
        generateForm();
        document.getElementById("filter").style.display = "none";
        recordData.evaluationListType = 1; // признак основної відомості
        document.getElementById("formWrap").style.display = "block";
        // console.log(recordData);
        break;
      case "createSecondForm":
        // createEvaluationListData();
        // document.getElementById("filter").style.display = "none";
        // generateForm();
        // recordData.evaluationListType = 2; // признак повторної відомості
        // document.getElementById("formWrap").style.display = "block";
        // console.log(recordData);
        break;
      case "closeForm":
        if (saveOrNotSave === 0) {
          dialogBox('Ви справді бажеєте залишити форму не зберігши дані?', (bool) => {
            if (bool === true) {
              document.getElementById("formWrap").style.display = "none";
              clearnEvaluationListData();
              document.getElementById("filter").style.display = "flex";
              saveOrNotSave = 1;
            }
          });
        } else if (saveOrNotSave === 2) {
          createSpinner();
          document.getElementById("formWrap").style.display = "none";
          clearnEvaluationListData();
          document.getElementById("filter").style.display = "flex";
          saveOrNotSave = 1;
          getTeacherEvolutionsLists(recordData
              .instituteId) // отримуємо відомості викладача по інституту для виведення актуальних даних
            .then((data) => {
              // успіх
              handBook.teacherEvolutionsLists = filterTeachersDelatedEvLists(data);
              generateTeacherEvolutionsLists(handBook.teacherEvolutionsLists);
              deleteSpinner();
            })
            .catch((e) => {
              // помилка
              console.log(e);
            })
        } else {
          document.getElementById("formWrap").style.display = "none";
          clearnEvaluationListData();
          document.getElementById("filter").style.display = "flex";
        }
        // console.log(recordData);
        break;
      case "saveForm":
        recordData.status = 0; // признак в роботі
        saveOrNotSave = 2; // вказівник на те що відбулися зміни
        createSpinner();
        setRecordData(recordData)
          .then((data) => {
            // успіх
            recordData.recordNumber = data.recordNumber;
            recordData.uid = data.uid;
            deleteSpinner();
            messageBox("Дані збережено");
            console.log(recordData);
          })
          .catch((e) => {
            // при помилці
            console.log(e);
          })
        break;
      case "subscribe":
        recordData.status = 1; // признак підписати
        saveOrNotSave = 2; // вказівник на те що відбулися зміни
        createSpinner();
        subscrideEvList(recordData)
          .then((data) => {
            // успіх
            recordData = cloneObj(data);
            messageBox("Дані збережено");

            sendEmail(recordData)
              .then((data) => {
                // успіх
                console.log(data);
                messageBox("PDF документ відомості створено");
                
                getTeacherEvolutionsLists(recordData
                    .instituteId) // отримуємо відомості викладача по інституту для виведення актуальних даних
                  .then((data) => {
                    // успіх
                    handBook.teacherEvolutionsLists = filterTeachersDelatedEvLists(data);
                    generateTeacherEvolutionsLists(handBook.teacherEvolutionsLists);

                    messageBox("Лист з відомістю надіслано");
                    document.getElementById("formWrap").style.display = "none";
                    document.getElementById("filter").style.display = "flex";
                    deleteSpinner();
                  })
                  .catch((e) => {
                    // помилка
                    console.log(e);
                  })
              })
              .catch((e) => {
                // при помилці
                console.log(e);
              })
          })
          .catch((e) => {
            // при помилці
            console.log(e);
          })
        break;
    }
  }

  function runTeachersEvListsForEditing(idAndRecordNumber) {
    let buffer = filterResources(handBook.teacherEvolutionsLists, "recordNumber", parseInt(idAndRecordNumber[1]));
    recordData = cloneObj(buffer[0]);
    document.getElementById("filter").style.display = "none";
    generateForm();
    document.getElementById("formWrap").style.display = "block";
  }

  function deleteTeacherEvList(idAndRecordNumber) {
    let buffer = cloneObj(filterResources(handBook.teacherEvolutionsLists, "recordNumber", parseInt(idAndRecordNumber[
      1])));
    dialogBox("Ви справді бажаєте видалити відомість?", (bool) => {
      if (bool === true) {
        createSpinner();
        buffer[0].status = -1;
        setRecordData(buffer[0])
          .then((data) => {
            // успіх
            getTeacherEvolutionsLists(recordData
                .instituteId) // отримуємо відомості викладача по інституту для виведення актуальних даних
              .then((data) => {
                // успіх
                handBook.teacherEvolutionsLists = filterTeachersDelatedEvLists(data);
                generateTeacherEvolutionsLists(handBook.teacherEvolutionsLists);
              })
              .catch((e) => {
                // помилка
                console.log(e);
              })
            deleteSpinner();

            console.log(data);
          })
          .catch((e) => {
            // при помилці
            console.log(e);
          })
      }
    })
  }

  function scanningFormInputs(id) {
    saveOrNotSave = 0; // вказівник на те що відбулися зміни
    switch (id) {
      case "studyCredits":
        let credit = +document.getElementById(`${id}`).value;
        recordData.evaluationListData[id] = credit;
        recordData.evaluationListData.hourAndCredit = `${credit * 30} (${credit})`;
        break;
      case "date":
        let date = document.getElementById(`${id}`).value,
          unixDate = new Date(date).getTime();

        recordData.evaluationListData.date = unixDate;
        break;
      case "aditionalTeachers":
        recordData.evaluationListData[id] = document.getElementById(`${id}`).value.split(",");
        break;
      default:
        recordData.evaluationListData[id] = document.getElementById(`${id}`).value;
    }
  }

  function scanningFormTable(id) {
    let marks = +document.getElementById(id).value,
      adres = id.split("-"),
      marksSum;

    saveOrNotSave = 0; // вказівник на те що відбулися зміни
    recordData.evaluationListData.students[adres[1] - 1][adres[0]] = marks;

    marksSum = (adres[0] == "currentGrade") ? +document.getElementById(`semesterGrade-${adres[1]}`).value : +
      document.getElementById(`currentGrade-${adres[1]}`).value;
    marksSum += marks;
    document.getElementById(`gradeSum-${adres[1]}`).value = marksSum;
    recordData.evaluationListData.students[adres[1] - 1]["gradeSum"] = marksSum;
  }

  function getDataInstituteGroups(instituteId) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          //deleteSpinner();
          resolve(res);
        })
        .withFailureHandler(reject)
        .getDataGroups(instituteId); // це функцыя з responnses
    });
  }

  function filterResources(arr, key, query) {
    return arr.filter(function (element) {
      return (element[key] === query) ? true : false; //елемент співпадає з рядком запиту
    });
  }

  function letterSort(lang, letters) {
    letters.sort((a, b) => new Intl.Collator(lang).compare(a.name, b.name));
    return letters;
  }

  function removeDuplicates(myArr, prop) {
    return myArr.filter((obj, pos, arr) => {
      return arr.map(mapObj => mapObj[prop]).indexOf(obj[prop]) === pos;
    });
  }

  function createEvaluationListData(allGroupInfo) {
    recordData.evaluationListData.institute = handBook.institutes[recordData.instituteId].nameinstitute;
    recordData.evaluationListData.educationalDegree = handBook.educational_degree[recordData.educationalDegreeId]
      .educationaldegreename;
    recordData.evaluationListData.educationalForm = handBook.form_of_training[recordData.formTrainingId]
      .formtrainingname;
    recordData.evaluationListData.studyYearAndSemester = handBook.сurrentStudyYearAndSemester;
    recordData.evaluationListData.date = Date.now();
    recordData.emailTeacher = handBook.user.email;
    recordData.recordNumber = -1;
    recordData.parent = 0;
    recordData.pdfId = "";
    recordData.spreadsheetId = "";
    recordData.uid = "";

    allGroupInfo.groupName = allGroupInfo.name;
    delete allGroupInfo.name;
    delete allGroupInfo.groupId;
    delete allGroupInfo.divisionId;
    delete allGroupInfo.educationalDegreeId;
    delete allGroupInfo.educationalFormId;

    allGroupInfo.students = cloneObj(letterSort('uk', allGroupInfo.students));

    allGroupInfo.students = cloneObj(removeDuplicates(allGroupInfo.students, "sudentId"));

    allGroupInfo.students.forEach(element => {
      element.currentGrade = "";
      element.semesterGrade = "";
      element.gradeSum = "";
    });

    for (let key in allGroupInfo) {
      recordData.evaluationListData[key] = allGroupInfo[key];
    }
  }

  function clearnEvaluationListData() {
    for (let key in recordData.evaluationListData) {
      switch (key) {
        case "aditionalTeachers":
          recordData.evaluationListData[key] = [];
          break;
        default:
          recordData.evaluationListData[key] = "";
      }
    }
  }

  function setRecordData(data) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          //deleteSpinner();
          resolve(res);
        })
        .withFailureHandler(reject)
        .writeDataToInstituteRouter(data); // це функцыя з responnses
    });
  }

  function subscrideEvList(data) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          //deleteSpinner();
          resolve(res);
        })
        .withFailureHandler(reject)
        .subscribeEvolutionsList(data); // це функцыя з responnses
    });
  }

  function sendEmail(data) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          //deleteSpinner();
          resolve(res);
        })
        .withFailureHandler(reject)
        .sendPdfToEmail(data); // це функцыя з responnses
    });
  }

  function getTeacherEvolutionsLists(id) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(res => {
          //deleteSpinner();
          resolve(res);
        })
        .withFailureHandler(reject)
        .getEvolutionListsByTeacher(id); // це функцыя з responnses
    });
  }

  function filterTeachersDelatedEvLists(list) {
    return filterResources(list, "status", 0).concat(filterResources(list, "status", 1));
  }

  /*---------------------------------------------------------------------------------------------------------*/

  // function showInfoFromDocument(data) {
  //   deleteSpinner();
  //   let message = document.getElementById("message");
  //   message.innerHTML = '<h4>' + data.name + '</h4>' + createTable(data.table1) + '<br>' + createTable(data.table2);
  //   // message.innerHTML = '<h4>'+data.name+'</h4>'+createTable(data.table1)+createTable(data.table2);
  //   message.style.display = "block";
  // }

  // function hiddenMessagesBlock() {
  //   let message = document.getElementById("message");
  //   message.style.display = "none";
  //   message.innerHTML = '';
  // }

  function createSpinner() {
    var div = document.createElement("div");
    var faspin = document.createElement("span");
    faspin.className = "fa fa-spinner fa-pulse";
    div.append(faspin);
    div.className = "modalBlock";
    div.id = "modalBlock";
    document.getElementById("data").appendChild(div);
  }

  function deleteSpinner() {
    if (document.getElementById("modalBlock")) document.getElementById("modalBlock").remove();
  }
</script>